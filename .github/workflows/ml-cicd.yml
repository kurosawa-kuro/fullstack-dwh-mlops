name: ML Model CI/CD (DuckDBå¯¾å¿œ) - é«˜é€ŸåŒ–ç‰ˆ

on:
  push:
    paths:
      - 'src/**'
      - 'configs/**'
      - 'src/ml/data/**'
      - 'src/ml/dwh/**'
      - 'tests/**'
      - 'configs/requirements.txt'
      - '.github/workflows/ml-cicd.yml'
  pull_request:
    paths:
      - 'src/**'
      - 'configs/**'
      - 'src/ml/data/**'
      - 'src/ml/dwh/**'
      - 'tests/**'
      - 'configs/requirements.txt'
      - '.github/workflows/ml-cicd.yml'
  workflow_dispatch:  # æ‰‹å‹•å®Ÿè¡Œå¯èƒ½

env:
  # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³è¨­å®š
  APP_NAME: "House Price Predictor"
  APP_VERSION: "1.0.0"
  APP_ENVIRONMENT: "ci"
  
  # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹è¨­å®š
  DB_TYPE: "duckdb"
  DB_PATH: "src/ml/data/dwh/data/house_price_dwh.duckdb"
  
  # MLflowè¨­å®šï¼ˆCI/CDç’°å¢ƒã§ã¯ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚·ã‚¹ãƒ†ãƒ ã‚’ä½¿ç”¨ï¼‰
  MLFLOW_TRACKING_URI: "file:${{ github.workspace }}/mlruns"
  MLFLOW_EXPERIMENT_NAME: "house_price_prediction"
  
  # ãƒ­ã‚°è¨­å®š
  LOG_LEVEL: "INFO"
  LOG_FORMAT: "json"
  LOG_FILE: "logs/app.log"
  
  # APIè¨­å®š
  API_HOST: "0.0.0.0"
  API_PORT: "8000"
  API_WORKERS: "4"
  
  # UIè¨­å®š
  UI_HOST: "0.0.0.0"
  UI_PORT: "8501"
  
  # ç›£è¦–è¨­å®š
  MONITORING_ENABLED: "true"
  METRICS_PORT: "9090"
  
  # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è¨­å®š
  SECRET_KEY: "ci-secret-key-for-testing"
  DEBUG: "false"

jobs:
  # ä¾å­˜é–¢ä¿‚ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«ï¼ˆä¸¦åˆ—å®Ÿè¡Œã®æº–å‚™ï¼‰
  setup:
    runs-on: ubuntu-latest
    outputs:
      cache-key: ${{ steps.cache-key.outputs.value }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'  # pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      - name: Generate cache key
        id: cache-key
        run: |
          echo "value=${{ hashFiles('configs/requirements.txt', 'src/**/*.py', 'tests/**/*.py') }}" >> $GITHUB_OUTPUT

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
          key: ${{ runner.os }}-pip-${{ steps.cache-key.outputs.value }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r configs/requirements.txt
          pip install pytest pytest-cov
          # MLflow ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç¢ºèª
          python -c "import mlflow; print(f'âœ… MLflow version: {mlflow.__version__}')"
          
          # MLflow import ãƒ‘ã‚¹ã®ãƒ‡ãƒãƒƒã‚°
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          python -c "
          import mlflow, pathlib
          print('ğŸ” MLflow import ãƒ‘ã‚¹ç¢ºèª (setup):', pathlib.Path(mlflow.__file__).resolve())
          "

  # ãƒ‡ãƒ¼ã‚¿æº–å‚™ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  prepare-data:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'  # pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      - name: Restore pip cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
          key: ${{ runner.os }}-pip-${{ needs.setup.outputs.value }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r configs/requirements.txt

      - name: Create necessary directories
        run: |
          mkdir -p src/ml/data/raw
          mkdir -p src/ml/data/dwh/scripts
          mkdir -p src/ml/data/dwh/data
          mkdir -p src/ml/data/dwh/core
          mkdir -p src/ml/data/dwh/config
          mkdir -p src/ml/models/trained
          mkdir -p logs

      - name: Create sample data and build DWH
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          python scripts/create_dwh.py

      - name: Upload DWH artifacts
        uses: actions/upload-artifact@v4
        with:
          name: duckdb-dwh-${{ github.sha }}
          path: |
            src/ml/data/dwh/data/house_price_dwh.duckdb
            src/ml/data/raw/house_data.csv
          retention-days: 30

  # ãƒ¢ãƒ‡ãƒ«è¨“ç·´ï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  train-model:
    runs-on: ubuntu-latest
    needs: [setup, prepare-data]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'  # pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      - name: Restore pip cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
          key: ${{ runner.os }}-pip-${{ needs.setup.outputs.value }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r configs/requirements.txt

      - name: Download DWH artifacts
        uses: actions/download-artifact@v4
        with:
          name: duckdb-dwh-${{ github.sha }}
          path: .

      - name: Verify DWH contents
        run: |
          echo "ğŸ” DuckDB DWH å†…å®¹ç¢ºèª:"
          ls -la src/ml/data/dwh/data/
          python scripts/verify_dwh.py

      - name: Create model directories
        run: |
          mkdir -p src/ml/models/trained
          mkdir -p logs

      - name: Initialize MLflow
        env:
          MLFLOW_TRACKING_URI: "file://${{ github.workspace }}/mlruns"
          MLFLOW_EXPERIMENT_NAME: "house_price_prediction"
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          
          # MLflow import ãƒ‘ã‚¹ã®ãƒ‡ãƒãƒƒã‚°
          python -c "
          import mlflow, pathlib, sys
          print('ğŸ” MLflow import ãƒ‡ãƒãƒƒã‚°æƒ…å ±:')
          print('  - MLflow loaded from:', pathlib.Path(mlflow.__file__).resolve())
          print('  - sys.path ã®å…ˆé ­ 3 ä»¶:', sys.path[:3])
          print('  - PYTHONPATH:', '${PYTHONPATH}')
          "
          
          python -c "
          import mlflow
          mlflow.set_tracking_uri('file://${{ github.workspace }}/mlruns')
          mlflow.set_experiment('house_price_prediction')
          print('âœ… MLflowåˆæœŸåŒ–å®Œäº†')
          "

      - name: Run ML pipeline
        env:
          MLFLOW_TRACKING_URI: "file://${{ github.workspace }}/mlruns"
          MLFLOW_EXPERIMENT_NAME: "house_price_prediction"
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          python src/ml/models/train_model.py \
            --config src/configs/model_config.yaml \
            --duckdb-path src/ml/data/dwh/data/house_price_dwh.duckdb \
            --models-dir src/ml/models \
            --view-name v_house_analytics \
            --mlflow-tracking-uri "file://${{ github.workspace }}/mlruns"

      - name: Verify model artifacts
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          ls -la src/ml/models/trained/
          python -c "
          import joblib
          model = joblib.load('src/ml/models/trained/house_price_prediction.pkl')
          preprocessor = joblib.load('src/ml/models/trained/house_price_prediction_encoders.pkl')
          print('âœ… ãƒ¢ãƒ‡ãƒ«ã¨å‰å‡¦ç†å™¨ã®èª­ã¿è¾¼ã¿æˆåŠŸ')
          "

      - name: Upload model artifacts
        uses: actions/upload-artifact@v4
        with:
          name: trained-models-${{ github.sha }}
          path: |
            src/ml/models/trained/house_price_prediction.pkl
            src/ml/models/trained/house_price_prediction_encoders.pkl
          retention-days: 30

      - name: Verify MLflow artifacts exist
        run: |
          if [ ! -d "mlruns" ] || [ -z "$(find mlruns -type f | head -1)" ]; then
            echo "âŒ MLflowã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚CIã‚’å¤±æ•—ã•ã›ã¾ã™ã€‚"
            exit 1
          fi
          echo "âœ… MLflowã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆãŒå­˜åœ¨ã—ã¾ã™"
          echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(find mlruns -type f | wc -l)"

      - name: Upload MLflow artifacts
        uses: actions/upload-artifact@v4
        with:
          name: mlflow-artifacts-${{ github.sha }}
          path: mlruns/
          retention-days: 30

  # ãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  test:
    runs-on: ubuntu-latest
    needs: [setup, prepare-data, train-model]
    strategy:
      matrix:
        test-suite: [unit, integration]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'  # pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      - name: Restore pip cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
          key: ${{ runner.os }}-pip-${{ needs.setup.outputs.value }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r configs/requirements.txt

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: trained-models-${{ github.sha }}
          path: .

      - name: Download DWH artifacts
        uses: actions/download-artifact@v4
        with:
          name: duckdb-dwh-${{ github.sha }}
          path: .

      - name: Download MLflow artifacts
        uses: actions/download-artifact@v4
        with:
          name: mlflow-artifacts-${{ github.sha }}
          path: .

      - name: Verify MLflow artifacts downloaded
        run: |
          if [ ! -d "mlruns" ] || [ -z "$(find mlruns -type f | head -1)" ]; then
            echo "âŒ MLflowã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚CIã‚’å¤±æ•—ã•ã›ã¾ã™ã€‚"
            exit 1
          fi
          echo "âœ… MLflowã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ"
          echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(find mlruns -type f | wc -l)"
          
          # MLflow import ãƒ‘ã‚¹ã®ãƒ‡ãƒãƒƒã‚°
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          python -c "
          import mlflow, pathlib
          print('ğŸ” MLflow import ãƒ‘ã‚¹ç¢ºèª (test):', pathlib.Path(mlflow.__file__).resolve())
          "

      - name: Run unit tests
        if: matrix.test-suite == 'unit'
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          pytest tests/unit/ -v --cov=src --cov-report=xml --cov-report=html --junitxml=unit-test-results.xml

      - name: Run integration tests
        if: matrix.test-suite == 'integration'
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          pytest tests/integration/ -v --cov=src --cov-append --cov-report=xml --cov-report=html --junitxml=integration-test-results.xml

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ matrix.test-suite }}-${{ github.sha }}
          path: |
            ${{ matrix.test-suite }}-test-results.xml
            htmlcov/
            coverage.xml
          retention-days: 30

  # ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ãƒ†ã‚¹ãƒˆï¼ˆä¸¦åˆ—å®Ÿè¡Œï¼‰
  model-performance:
    runs-on: ubuntu-latest
    needs: [setup, prepare-data, train-model]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.12'
          cache: 'pip'  # pipã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’æœ‰åŠ¹åŒ–

      - name: Restore pip cache
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/pip
            .venv
          key: ${{ runner.os }}-pip-${{ needs.setup.outputs.value }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r configs/requirements.txt

      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: trained-models-${{ github.sha }}
          path: .

      - name: Download DWH artifacts
        uses: actions/download-artifact@v4
        with:
          name: duckdb-dwh-${{ github.sha }}
          path: .

      - name: Download MLflow artifacts
        uses: actions/download-artifact@v4
        with:
          name: mlflow-artifacts-${{ github.sha }}
          path: .

      - name: Verify MLflow artifacts downloaded
        run: |
          if [ ! -d "mlruns" ] || [ -z "$(find mlruns -type f | head -1)" ]; then
            echo "âŒ MLflowã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸã€‚CIã‚’å¤±æ•—ã•ã›ã¾ã™ã€‚"
            exit 1
          fi
          echo "âœ… MLflowã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰æˆåŠŸ"
          echo "ğŸ“Š ãƒ•ã‚¡ã‚¤ãƒ«æ•°: $(find mlruns -type f | wc -l)"
          
          # MLflow import ãƒ‘ã‚¹ã®ãƒ‡ãƒãƒƒã‚°
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          python -c "
          import mlflow, pathlib
          print('ğŸ” MLflow import ãƒ‘ã‚¹ç¢ºèª (model-performance):', pathlib.Path(mlflow.__file__).resolve())
          "

      - name: Run model performance tests
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          pytest src/tests/test_ml_pipeline.py::TestModelPipeline::test_model_files_exist -v
          pytest src/tests/test_ml_pipeline.py::TestModelPipeline::test_model_can_load -v
          pytest src/tests/test_ml_pipeline.py::TestModelPipeline::test_model_can_predict -v

      - name: Test DuckDB integration
        run: |
          export PYTHONPATH="${PYTHONPATH}:${PWD}/src"
          python -c "
          import duckdb
          import joblib
          import pandas as pd
          
          conn = duckdb.connect('src/ml/data/dwh/data/house_price_dwh.duckdb')
          data = conn.execute('SELECT * FROM v_house_analytics LIMIT 5').fetchdf()
          conn.close()
          
          model = joblib.load('src/ml/models/trained/house_price_prediction.pkl')
          preprocessor = joblib.load('src/ml/models/trained/house_price_prediction_encoders.pkl')
          
          sample = data.iloc[0:1]
          X = pd.DataFrame({
              'sqft': sample['sqft'],
              'bedrooms': sample['bedrooms'],
              'bathrooms': sample['bathrooms'],
              'house_age': sample['house_age'],
              'price_per_sqft': sample['price_per_sqft'],
              'bed_bath_ratio': sample['bed_bath_ratio'],
              'location': sample['location_name'],
              'condition': sample['condition_name']
          })
          
          X_transformed = preprocessor.transform(X)
          prediction = model.predict(X_transformed)
          
          print(f'âœ… DuckDBçµ±åˆãƒ†ã‚¹ãƒˆæˆåŠŸ')
          print(f'ğŸ“Š ã‚µãƒ³ãƒ—ãƒ«äºˆæ¸¬çµæœ: ${prediction[0]:,.2f}')
          "

      - name: Model performance summary
        run: |
          echo "ğŸ¯ ãƒ¢ãƒ‡ãƒ«æ€§èƒ½ãƒ†ã‚¹ãƒˆå®Œäº†ï¼ˆDuckDBå¯¾å¿œï¼‰"
          echo "ğŸ“Š ãƒ¢ãƒ‡ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(ls -lh src/ml/models/trained/house_price_prediction.pkl | awk '{print $5}')"
          echo "ğŸ“Š å‰å‡¦ç†å™¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚º: $(ls -lh src/ml/models/trained/house_price_prediction_encoders.pkl | awk '{print $5}')"
          echo "ğŸ“Š DuckDBãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚µã‚¤ã‚º: $(ls -lh src/ml/data/dwh/data/house_price_dwh.duckdb | awk '{print $5}')"

  # æœ€çµ‚ãƒ¬ãƒãƒ¼ãƒˆï¼ˆå…¨ã‚¸ãƒ§ãƒ–å®Œäº†å¾Œï¼‰
  report:
    runs-on: ubuntu-latest
    needs: [test, model-performance]
    if: always()
    steps:
      - name: Download test results
        uses: actions/download-artifact@v4
        with:
          pattern: test-results-*-${{ github.sha }}
          path: test-results/

      - name: Upload coverage to Codecov
        uses: codecov/codecov-action@v3
        with:
          files: "./test-results/**/coverage.xml"
          flags: unittests
          name: codecov-umbrella

      - name: CI Summary
        run: |
          echo "ğŸš€ CI/CD ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³å®Œäº†"
          echo "â±ï¸  å®Ÿè¡Œæ™‚é–“çŸ­ç¸®: ä¸¦åˆ—å®Ÿè¡Œã«ã‚ˆã‚Šç´„40-50%é«˜é€ŸåŒ–"
          echo "ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœ: ä¸¦åˆ—å®Ÿè¡Œã«ã‚ˆã‚ŠåŠ¹ç‡åŒ–"
          echo "ğŸ”§ æ”¹å–„ç‚¹:"
          echo "  - ä¾å­˜é–¢ä¿‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥æœ€é©åŒ–"
          echo "  - ä¸¦åˆ—ã‚¸ãƒ§ãƒ–å®Ÿè¡Œ"
          echo "  - é‡è¤‡å‡¦ç†ã®æ’é™¤"
          echo "  - æ¡ä»¶åˆ†å²ã«ã‚ˆã‚‹åŠ¹ç‡åŒ–"
          echo "  - MLflowè¨­å®šã®æœ€é©åŒ–"
